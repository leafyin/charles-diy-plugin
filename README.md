## Charles æ’ä»¶å¼€å‘



### ä¸‹è½½æœ€æ–°çš„Charles

[Charleså®˜ç½‘åœ°å€](https://www.charlesproxy.com/)ï¼Œå®‰è£…ååœ¨å®‰è£…ç›®å½•ä¸‹æ‰¾åˆ°charles.jaråŒ…



### è¿›è¡Œå¼€å‘çš„æ—¶å€™çš„æ³¨æ„äº‹é¡¹ğŸ¤“

* è¿›è¡ŒäºŒæ¬¡å¼€å‘çš„çš„éƒ¨åˆ†æ˜¯Charleså·¥å…·ä¸­çš„charles.jaråŒ…ï¼Œéœ€è¦å…ˆæŠŠjaråŒ…è¿›è¡Œåç¼–è¯‘ï¼ˆç¨åä»‹ç»å¦‚ä½•è¿›è¡Œåç¼–è¯‘ï¼‰

* Charlesæ¯æ¬¡è¿›è¡Œç‰ˆæœ¬æ›´æ–°åä¼šä»£ç ä¼šæ··æ·†ï¼Œéœ€è¦æ³¨æ„æ›´æ–°åcharles.jaråŒ…ä¸­ä½¿ç”¨åˆ°çš„ç±»åæˆ–è€…å‡½æ•°ï¼ˆæ„é€ æ–¹æ³•...ï¼‰åè¿›è¡Œæ”¹å

* è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯æŠ¥åæ–°åŠŸèƒ½æŠ¥åéœ€è¦è·ŸCharleså·¥ç¨‹ç›®å½•ç»“æ„ä¸€è‡´ï¼Œæ–¹ä¾¿åé¢æŠŠæ–°åŠŸèƒ½æ·»åŠ è‡³charles.jaråŒ…ä¸­

* æ–‡æ¡£æœ€åç”¨åˆ°jar -ufå‘½ä»¤

  ## JAR å‘½ä»¤

  | å‘½ä»¤     | è¯´æ˜                                                         |
    | -------- | :----------------------------------------------------------- |
  | -c       | åœ¨æ ‡å‡†è¾“å‡ºä¸Šåˆ›å»ºæ–°å½’æ¡£æˆ–ç©ºå½’æ¡£ã€‚                             |
  | -C       | åœ¨æ‰§è¡Œ jar å‘½ä»¤æœŸé—´æ›´æ”¹ç›®å½•ã€‚**jar -uf a.jar -C classes \*** å°† classes ç›®å½•å†…çš„æ‰€æœ‰æ–‡ä»¶åŠ åˆ° a.jar ä¸­ï¼Œä½†ä¸æ·»åŠ ç±»ç›®å½•æœ¬èº«ã€‚ |
  | -f       | ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šè¦å¤„ç†çš„ jar æ–‡ä»¶(æ–‡ä»¶åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯è¦åˆ›å»ºæˆ–è®¿é—®çš„å­˜æ¡£æ–‡ä»¶åå­—)ã€‚åœ¨ -c (åˆ›å»º)æƒ…å½¢ä¸­ï¼Œç¬¬äºŒä¸ªå‚æ•°æŒ‡çš„æ˜¯è¦åˆ›å»ºçš„ jar æ–‡ä»¶çš„åç§°(ä¸æ˜¯åœ¨æ ‡å‡†è¾“å‡ºä¸Š)ã€‚åœ¨ -t (è¡¨(æˆ– -x (æŠ½å–)è¿™ä¸¤ç§æƒ…å½¢ä¸­ï¼Œç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šè¦åˆ—å‡ºæˆ–æŠ½å–çš„ jar æ–‡ä»¶ã€‚ |
  | -i       | åº”æä¾›çš„ç´¢å¼•ä¿¡æ¯ã€‚                                           |
  | -m       | åŒ…æ‹¬æŒ‡å®šçš„ç°æœ‰æ¸…å•æ–‡ä»¶ä¸­çš„æ¸…å•ä¿¡æ¯ï¼ˆæ–‡ä»¶åˆ—è¡¨çš„ç¬¬äºŒä¸ªå…ƒç´ æ˜¯å¤–éƒ¨çš„æ¸…å•æ–‡ä»¶åï¼‰ã€‚ç”¨æ³•ä¸¾ä¾‹ï¼š**jar cmf myManifestFile myJarFile \*.class** |
  | -M       | ä¸åˆ›å»ºé¡¹ç›®çš„æ¸…å•æ–‡ä»¶ã€‚                                       |
  | -t       | åœ¨æ ‡å‡†è¾“å‡ºä¸Šåˆ—å‡ºå†…å®¹è¡¨(å­˜æ¡£æ–‡ä»¶çš„å†…å®¹åº”åˆ¶æˆè¡¨æ ¼)ã€‚           |
  | -u       | é€šè¿‡æ·»åŠ æ–‡ä»¶æˆ–æ›´æ”¹æ¸…å•æ¥æ›´æ–°ç°æœ‰çš„ JAR æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼š**jar -uf a.jar a.class** å°†æ–‡ä»¶ a.class æ·»åŠ åˆ°ç°æœ‰çš„ JAR æ–‡ä»¶ a.jar ä¸­ï¼Œè€Œ **jar umf manifest foo.jar** åˆ™ç”¨ manifest ä¸­çš„ä¿¡æ¯æ›´æ–° a.jar çš„æ¸…å•ã€‚ |
  | -v       | åœ¨æ ‡å‡†é”™è¯¯è¾“å‡ºè®¾å¤‡ä¸Šç”Ÿæˆé•¿æ ¼å¼çš„è¾“å‡ºç»“æœ(å½“å·¥å…·æ‰§è¡Œæ—¶æ˜¾ç¤ºçš„è¯¦ç»†ä¿¡æ¯)ã€‚ |
  | -x[file] | ä»æ ‡å‡†è¾“å…¥æå–æ‰€æœ‰æ–‡ä»¶ï¼Œæˆ–åªæå–æŒ‡å®šçš„æ–‡ä»¶ã€‚å¦‚æœçœç•¥äº† fileï¼Œåˆ™æå–æ‰€æœ‰æ–‡ä»¶ï¼›å¦åˆ™åªæå–æŒ‡å®šæ–‡ä»¶ã€‚ |
  | -0       | åªå‚¨å­˜ï¼Œä¸è¿›è¡Œ ZIP å‹ç¼©ã€‚                                    |



### æ‹¿åˆ°charles.jaråŒ…ä¹‹åè¿›è¡Œåç¼–è¯‘

[åç¼–è¯‘](https://www.decompiler.com/)ç½‘ç«™ï¼Œä¼šæŠŠä¸Šä¼ jaråŒ…æ–‡ä»¶åç¼–è¯‘ä¸ºæºç ï¼Œç„¶åä¸‹è½½åç¼–è¯‘åçš„æºç 



### å°†ä»£ç ç”¨IDEAæ‰“å¼€

* æ‰“å¼€åæ‰¾åˆ°éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†ï¼ŒCharlesæ˜¯ç”¨javaè¯­è¨€å†™çš„ç•Œé¢ï¼ˆjava swingé¡¹ç›®ï¼‰ï¼Œä¸€èˆ¬UIå¤„çš„æ”¹åŠ¨éƒ½åœ¨guiç›®å½•ä¸‹

![image-20210519164243284](./img/image-20210519164243284.png)



### å¦‚ä½•è¿›è¡ŒäºŒæ¬¡å¼€å‘

1. æ‹¿åšå¥½çš„ä¸€ä¸ªåŠŸèƒ½æ¥ä¸¾ä¾‹å­ï¼ŒåŠŸèƒ½ï¼ˆè§£å¯†æ¥å£è¯·æ±‚å‚æ•°ï¼‰ï¼Œä¸‹é¢æ˜¯å®Œæˆå›¾ï¼Œæ–°å¢äº†3ä¸ªå°åŠŸèƒ½è§£å¯†ä¸åŒçš„è¯·æ±‚å‚æ•°ï¼ŒåŸæœ¬Charlesä¼šè‡ªå¸¦ä¸€ä¸ªBase64   Decode åŠŸèƒ½ï¼Œä½†æ˜¯å¹¶ä¸èƒ½æ»¡è¶³è§£å¯†éœ€æ±‚

![image-20210519165837719](./img/image-20210519165837719.png)

2. å…ˆé€šè¿‡IDEAæ‰“å¼€ä»£ç åå…ˆæ‰¾åˆ°ç›®æ ‡æºç çš„ä½ç½®ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥é€šè¿‡IDEAå…³é”®å­—æŸ¥æ‰¾åŠŸèƒ½äº†ï¼ŒWindowså¿«æ·é”®æ˜¯åŒå‡»shifté”®ï¼ŒæŸ¥æ‰¾å…³é”®å­—ï¼ˆBase 64 Decodeï¼‰

   ![image-20210519171039521](./img/image-20210519170846142.png)

ç„¶åä¼šçœ‹åˆ°è¿™ä¹ˆ3ä¸ªç±»ï¼ŒBase64DecodeAction$Textã€Base64DecodeAction$TextComponentã€Base64DecodeActionï¼Œå‰é¢ä¸¤ä¸ªæ˜¯å­ç±»ï¼ˆå…³äºç»„ä»¶è§£å¯†å’Œæ–‡æœ¬è§£å¯†ï¼‰ï¼Œåé¢ä¸€ä¸ªæ˜¯å…³é”®çš„çˆ¶ç±»ï¼Œç‚¹è¿›å»çœ‹çœ‹ï¼Œå¦‚ä¸‹ï¼Œèœå•åç§°éšä¾¿æ”¹ï¼Œä¸»è¦è§£å¯†é€»è¾‘ä»£ç æ ¹æ®è‡ªå·±éœ€æ±‚è¿›è¡Œæ”¹åŠ¨ï¼Œåé¢è§£å¯†åçš„å¼¹çª—ä¹Ÿå¯ä»¥è¿›è¡Œé‡æ–°å†™ä¸€ä¸ª

```
Base64DecodeAction
```

```java
package com.xk72.charles.gui.transaction.actions;

import com.xk72.charles.CharlesContext;
import com.xk72.charles.gui.lib.SsDg;
import com.xk72.charles.gui.transaction.lib.HexAsciiTextPane;
import java.awt.Component;
import java.awt.Dimension;
import java.awt.Point;
import java.awt.event.ActionEvent;
import java.util.Base64;
import javax.swing.AbstractAction;
import javax.swing.JScrollPane;

public abstract class Base64DecodeAction extends AbstractAction {
    private final Component source;

    protected Base64DecodeAction(Component var1) {
        //èœå•çš„åç§°
        super("Base 64 Decode");
        this.source = var1;
    }

    protected abstract String getBody();

    public void actionPerformed(ActionEvent var1) {
        //è¿™ä¸€å—æ˜¯çš„ä¸»è¦è§£å¯†çš„é€»è¾‘ä»£ç 
        byte[] var2;
        try {
            var2 = Base64.getDecoder().decode(this.getBody());
        } catch (Exception var5) {
            //å¼‚å¸¸å¤„ç†ï¼Œè¿™å—å¯ä»¥ç”¨Charlesè‡ªå¸¦çš„å¼‚å¸¸å¤„ç†æ–¹å¼ï¼Œæ–¹ä¾¿è°ƒè¯•
            CharlesContext.getInstance().error("Failed to decode Base 64. Probably not valid Base 64 input.");
            return;
        }

        //è§£å¯†ç»“æœçš„å¼¹çª—
        HexAsciiTextPane var3 = new HexAsciiTextPane();
        var3.setEditable(false);
        var3.setBytes(var2);
        JScrollPane var4 = new JScrollPane(var3);
        var4.setPreferredSize(new Dimension(700, 200));
        SsDg.XdKP(var4, this.source, (Point)null);
    }
}
```

ä¸‹é¢ä¸¤ä¸ªå­ç±»å®Œå…¨å¯ä»¥ç…§æŠ„

```
Base64DecodeAction$Text
```

```java
package com.xk72.charles.gui.transaction.actions;

import java.awt.Component;

public class Base64DecodeAction$Text extends Base64DecodeAction {
    private final String text;

    public Base64DecodeAction$Text(String var1) {
        super((Component)null);
        this.text = var1;
    }

    public Base64DecodeAction$Text(String var1, Component var2) {
        super(var2);
        this.text = var1;
    }

    protected String getBody() {
        return this.text;
    }
}
```

```
Base64DecodeAction$TextComponent
```

```java
package com.xk72.charles.gui.transaction.actions;

import javax.swing.text.JTextComponent;

public class Base64DecodeAction$TextComponent extends Base64DecodeAction {
    private final JTextComponent component;

    public Base64DecodeAction$TextComponent(JTextComponent var1) {
        super(var1);
        this.component = var1;
    }

    protected String getBody() {
        String var1 = this.component.getSelectedText();
        if (var1 == null) {
            var1 = this.component.getText();
        }

        return var1;
    }
}
```

3. é™„ä¸Šè‡ªå·±çš„ä»£ç ï¼ˆä¸»è¦çš„ç±»ï¼‰ï¼Œè§£å¯†çš„æ–¹å¼é€šè¿‡äº†ä¸€å±‚æœåŠ¡ç«¯è¿›è¡Œäº†ä»£ç†ç„¶åè¿”å›çš„ï¼Œå…·ä½“æ€ä¹ˆè§£å¯†å¯ä»¥æŒ‰ç…§è‡ªå·±çš„éœ€æ±‚

   ```java
   package com.xk72.charles.gui.transaction.popups;
   
   import com.xk72.charles.CharlesContext;
   
   import javax.swing.*;
   import java.awt.*;
   import java.awt.event.*;
   
   public abstract class CharlesUrlDecode extends AbstractAction {
   
       private final Component component;
   
       protected CharlesUrlDecode(Component component){
           super("Decode to Json");
           this.component = component;
       }
   
       protected abstract String getBody();
   
       public void actionPerformed(ActionEvent actionEvent) {
           String json = "";
           try {
               String sourceJson = this.getBody();
               if (sourceJson.contains(":") && sourceJson.contains("{")){
                   sourceJson = JsonUtils.getValueByJson(sourceJson);
               }
               StringBuilder sb = new StringBuilder();
               sb.append("{").append("\"code\"").append(":\"").append(sourceJson).append("\"}");
               json = HttpUtils.doPost("http://*.*.*.*:****/decodeJson", sb.toString());
               json = JsonUtils.formatJson(json);
           }catch (Exception e){
               CharlesContext.getInstance().error("Fail to json decode!");
           }
   
           new ResultDialog(json);
       }
   
   }
   ```

   è‡ªå®šä¹‰çš„å¼¹çª—ç±»

   ```java
   package com.xk72.charles.gui.transaction.popups;
   
   import javax.swing.*;
   import javax.swing.text.BadLocationException;
   import javax.swing.text.DefaultHighlighter;
   import javax.swing.text.Highlighter;
   import java.awt.*;
   import java.awt.event.*;
   
   public class ResultDialog extends JFrame implements ActionListener {
   
       JButton searchBtn = new JButton("æœç´¢");
       JTextField textField = new JTextField();
       JTextArea textArea = new JTextArea();
   
       private static String searchHistory = "";
   
       public ResultDialog(String content){
           this.setTitle("decode result");
           JToolBar toolBar = new JToolBar();
           textField.setText(searchHistory);
           toolBar.add(textField);
           toolBar.add(searchBtn);
           searchBtn.addActionListener(this);
           this.add(toolBar, BorderLayout.PAGE_START);
           textArea.setEditable(false);
           textArea.setText(content);
           textArea.setCaretPosition(0);
           textArea.setWrapStyleWord(true);
           textArea.setLineWrap(true);
           textArea.setSize(new Dimension(1000,500));
           this.add(new JScrollPane(textArea),BorderLayout.CENTER);
           this.pack();
           this.setLocation(400,100);
           this.setVisible(true);
       }
   
       @Override
       public void actionPerformed(ActionEvent actionEvent) {
           if (actionEvent.getSource() == searchBtn){
               String findText = textField.getText();
               String text = textArea.getText();
               //ä¿å­˜ä¸Šæ¬¡æœç´¢å¾—å†…å®¹
               searchHistory = findText;
               if (findText.equals("") || findText.length() == 0){
                   return;
               }
               if (!text.contains(findText)){
                   JOptionPane.showMessageDialog(this,"å†…å®¹æœªæ‰¾åˆ°ï¼");
               } else {
                   Highlighter highlighter = textArea.getHighlighter();
                   DefaultHighlighter.DefaultHighlightPainter painter = new DefaultHighlighter.DefaultHighlightPainter(Color.RED);
                   highlighter.removeAllHighlights();
                   int index = 0,length;
                   while ((index = text.indexOf(findText,index)) >= 0){
                       try{
                           length = findText.length();
                           highlighter.addHighlight(index,index + length,painter);
                           index += length;
                       }catch (BadLocationException e){
                           e.printStackTrace();
                       }
                   }
               }
           }
       }
   }
   ```

   æœ€åå°†å†™å¥½çš„ä¸¤ä¸ªåŠŸèƒ½æ·»åŠ åˆ°èœå•ä¸­

   ```java
   package com.xk72.charles.gui.transaction.popups;
   
   import com.xk72.charles.gui.find.AdvancedFindDialog;
   import com.xk72.charles.gui.navigator.elVd;
   import com.xk72.charles.gui.session.popups.TransactionPopupMenu;
   import com.xk72.charles.gui.session.tGFF;
   import com.xk72.charles.gui.transaction.actions.Base64DecodeAction$Text;
   import com.xk72.charles.gui.transaction.actions.Base64DecodeAction$TextComponent;
   import com.xk72.charles.gui.transaction.actions.CopyToClipboardAction$Text;
   import com.xk72.charles.gui.transaction.actions.CopyToClipboardAction$TextComponent;
   import com.xk72.charles.gui.transaction.popups.ZYSRF.ZYDecodeText;
   import com.xk72.charles.gui.transaction.popups.ZYSRF.ZYDecodeTextComponent;
   import com.xk72.charles.model.Transaction;
   import java.awt.Component;
   import java.awt.Point;
   import java.awt.event.MouseEvent;
   import javax.swing.JTable;
   import javax.swing.text.JTextComponent;
   
   public class TransactionViewerPopupMenu extends TransactionPopupMenu {
      public TransactionViewerPopupMenu(Transaction var1) {
         super(var1, (elVd)null, (tGFF)null, (AdvancedFindDialog)null);
      }
   
      protected void prepare(MouseEvent var1) {
         Component var2;
         if ((var2 = (Component)var1.getSource()) instanceof JTable) {
            JTable var3 = (JTable)var2;
            Point var5 = var1.getPoint();
            int var4 = var3.rowAtPoint(var5);
            int var6 = var3.columnAtPoint(var5);
            Object var7;
            if (var4 >= 0 && var6 >= 0 && (var7 = var3.getValueAt(var4, var6)) != null) {
               this.add(new CopyToClipboardAction$Text(var7.toString()));
               if (var7 instanceof String) {
                  this.add(new Base64DecodeAction$Text((String)var7, var2));
                   //çº¯å­—ç¬¦ä¸²è§£å¯†çš„æ—¶å€™æ·»åŠ è¿›èœå•ï¼Œç…§è‘«èŠ¦ç”»ç“¢å°±è¡Œäº†
                  this.add(new CharlesUrlDecodeText((String)var7, var2));
                  this.add(new ZYDecodeText((String)var7, var2));
                  this.add(new CKDecodeText((String)var7, var2));
               }
   
               this.addSeparator();
            }
         } else if (var2 instanceof JTextComponent) {
            this.add(new CopyToClipboardAction$TextComponent((JTextComponent)var2));
            this.add(new Base64DecodeAction$TextComponent((JTextComponent)var2));
             //æ˜¯æ–‡æœ¬ç»„ä»¶çš„æ—¶å€™ä¹Ÿæ·»åŠ è¿›èœå•
            this.add(new CharlesUrlDecodeTextComponent((JTextComponent)var2));
            this.add(new ZYDecodeTextComponent((JTextComponent)var2));
            this.add(new CKDecodeTextComponent((JTextComponent)var2));
            this.addSeparator();
         }
   
         super.prepare(false);
      }
   }
   ```

åˆ°è¿™ç¼–ç å°±ç»“æŸäº†



### ç¼–è¯‘ä»£ç 

ç”¨IDEAè‡ªå¸¦çš„buildè¿›è¡Œç¼–è¯‘ï¼Œé¡¶éƒ¨èœå•æ Build  ----  Build project

![image-20210519175638857](./img/image-20210519175638857.png)

ç¼–è¯‘å®Œæˆåä¼šæœ‰classæ–‡ä»¶åœ¨é¡¹ç›®outç›®å½•ä¸‹ç”Ÿæˆï¼ŒæŠŠç¼–è¯‘åäº§ç‰©è¿›è¡Œæ‹·è´ï¼Œæ”¾å…¥ä¸€ä¸ªç›®å½•ä¸‹

![image-20210519180029507](./img/image-20210519180029507.png)



### æŠŠclassæ–‡ä»¶åŠ å…¥åˆ°jaråŒ…ä¸­

æŠŠcharles.jaråŒ…å’Œç¼–è¯‘åçš„äº§ç‰©æ”¾åˆ°åŒä¸€ä¸ªç›®å½•ä¸‹é¢ï¼Œæ‰§è¡Œä¸€ä¸ªæˆ‘æä¾›çš„ä¸€ä¸ªè„šæœ¬ï¼Œæ‰§è¡Œå®Œä¹‹åæ–°å¢çš„å†…å®¹å°±æ·»åŠ è¿›å»äº†ï¼Œç„¶åæ›¿æ¢æ‰è€çš„jaråŒ…é‡æ–°å¯åŠ¨Charleså°±å¯ä»¥äº†ï¼

```shell
#!/bin/bash
jar -uf ./charles.jar com/xk72/charles/gui/transaction/popups/CharlesUrlDecode.class
jar -uf ./charles.jar com/xk72/charles/gui/transaction/popups/CharlesUrlDecodeText.class
jar -uf ./charles.jar com/xk72/charles/gui/transaction/popups/TransactionViewerPopupMenu.class
jar -uf ./charles.jar com/xk72/charles/gui/transaction/popups/CharlesUrlDecodeTextComponent.class
jar -uf ./charles.jar com/xk72/charles/gui/transaction/popups/HttpUtils.class
jar -uf ./charles.jar com/xk72/charles/gui/transaction/popups/JsonUtils.class
jar -uf ./charles.jar com/xk72/charles/gui/transaction/popups/ResultDialog.class
```



